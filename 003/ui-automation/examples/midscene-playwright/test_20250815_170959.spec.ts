import { expect } from "@playwright/test";
import { test } from "./fixture";

test.describe("é®å·å¡«åæµè¯", () => {
  test.beforeEach(async ({ page }) => {
    page.setViewportSize({ width: 1280, height: 768 });
    await page.goto("https://www.wjx.cn/vm/w4e8hc9.aspx");
    await page.waitForLoadState("networkidle");
  });

  test("å®æ´å¡«åé®å·å¹¶æäº¤", async ({
    ai,
    aiTap,
    aiInput,
    aiWaitFor,
    aiAssert,
    aiScroll,
    aiAsk
  }) => {
    // 1. æ£æ¥å¹¶ç¹å»å¼å§ä½ç­æé®ï¼å¦ææï¼
    try {
      await aiTap('å¼å§ä½ç­æé®', { timeoutMs: 3000 });
      await aiWaitFor('é®å·é¢ç®å·²æ¾ç¤º', { timeoutMs: 5000 });
    } catch (e) {
      console.log('æªæ¾å°å¼å§ä½ç­æé®ï¼ç´æ¥è¿å¥é®å·');
    }

    // 2. éé¢å¡«åé®å·
    // æ¨çæ§å«ï¼éæ©ç·
    await aiTap('æ§å«éæ©ä¸­ç"ç·"éé¡¹');
    await aiWaitFor('æ§å«éæ©å·²å®æ', { timeoutMs: 2000 });

    // è¿å»3ä¸ªææ¯å¦ç½è´­ï¼éæ©æ¯
    await aiTap('"è¿å»3ä¸ªææ¯å¦ç½è´­"é®é¢ä¸­ç"æ¯"éé¡¹');
    await aiWaitFor('ç½è´­éæ©å·²å®æ', { timeoutMs: 2000 });

    // ä¸»è¦åå å¤éï¼å¾éæ¶å°æè¶£ãå®ä½åºé¾ä»¥ä¹°å°
    await aiTap('"ä¸»è¦åå "å¤éé¢ä¸­ç"æ¶å°æè¶£"éé¡¹');
    await aiTap('"ä¸»è¦åå "å¤éé¢ä¸­ç"å®ä½åºé¾ä»¥ä¹°å°"éé¡¹');
    await aiWaitFor('ä¸»è¦åå éæ©å·²å®æ', { timeoutMs: 2000 });

    // ä¸»è¦è´­ä¹°å¤éï¼å¾éçµå­äº§åãä¹¦ç±
    await aiScroll({ direction: 'down', distance: 200 }, 'é®å·é¡µé¢');
    await aiTap('"ä¸»è¦è´­ä¹°"å¤éé¢ä¸­ç"çµå­äº§å"éé¡¹');
    await aiTap('"ä¸»è¦è´­ä¹°"å¤éé¢ä¸­ç"ä¹¦ç±"éé¡¹');
    await aiWaitFor('ä¸»è¦è´­ä¹°éæ©å·²å®æ', { timeoutMs: 2000 });

    // ç½è´­é¢çï¼éæ©æ¯å¨ï¼æ¬¡
    await aiTap('"ç½è´­é¢ç"é®é¢ä¸­ç"æ¯å¨ï¼æ¬¡"éé¡¹');
    await aiWaitFor('ç½è´­é¢çéæ©å·²å®æ', { timeoutMs: 2000 });

    // æåè±è´¹ï¼éæ©ï¼ï¼ï¼ï¼ï¼ï¼ï¼å
    await aiScroll({ direction: 'down', distance: 200 }, 'é®å·é¡µé¢');
    await aiTap('"æåè±è´¹"é®é¢ä¸­ç"ï¼ï¼ï¼ï¼ï¼ï¼ï¼å"éé¡¹');
    await aiWaitFor('æåè±è´¹éæ©å·²å®æ', { timeoutMs: 2000 });

    // åæ¬¢çä¿éå¤éï¼å¾éææãèµ éä¼æ å¸
    await aiTap('"åæ¬¢çä¿é"å¤éé¢ä¸­ç"ææ"éé¡¹');
    await aiTap('"åæ¬¢çä¿é"å¤éé¢ä¸­ç"èµ éä¼æ å¸"éé¡¹');
    await aiWaitFor('ä¿éåå¥½éæ©å·²å®æ', { timeoutMs: 2000 });

    // å¯¹ç½ç»æ¯ä»æåº¦ï¼éæ©æ¯è¾æ¾å¿
    await aiScroll({ direction: 'down', distance: 200 }, 'é®å·é¡µé¢');
    await aiTap('"å¯¹ç½ç»æ¯ä»æåº¦"é®é¢ä¸­ç"æ¯è¾æ¾å¿"éé¡¹');
    await aiWaitFor('æ¯ä»æåº¦éæ©å·²å®æ', { timeoutMs: 2000 });

    // æé¿éè¾¾å¯æ¥åï¼éæ©ï¼ï¼ï¼å¤©
    await aiTap('"æé¿éè¾¾å¯æ¥å"é®é¢ä¸­ç"ï¼ï¼ï¼å¤©"éé¡¹');
    await aiWaitFor('éè¾¾æ¶é´éæ©å·²å®æ', { timeoutMs: 2000 });

    // ææå¿å ç´ ï¼éæ©å¾çåå®ç©æå·®è·
    await aiScroll({ direction: 'down', distance: 200 }, 'é®å·é¡µé¢');
    await aiTap('"ææå¿å ç´ "é®é¢ä¸­ç"å¾çåå®ç©æå·®è·"éé¡¹');
    await aiWaitFor('æå¿å ç´ éæ©å·²å®æ', { timeoutMs: 2000 });

    // æ»ä½æ»¡æåº¦ï¼éæ©æ¯è¾æ»¡æ
    await aiTap('"æ»ä½æ»¡æåº¦"é®é¢ä¸­ç"æ¯è¾æ»¡æ"éé¡¹');
    await aiWaitFor('æ»¡æåº¦éæ©å·²å®æ', { timeoutMs: 2000 });

    // æè§å»ºè®®ï¼è¾å¥é¢ç®æ¸æ°ï¼å»ºè®®å¢å éç§æç¤ºä¸è¿åº¦æ¾ç¤ºï¼ç§»å¨ç«¯æ´åå¥½
    await aiInput(
      'é¢ç®æ¸æ°ï¼å»ºè®®å¢å éç§æç¤ºä¸è¿åº¦æ¾ç¤ºï¼ç§»å¨ç«¯æ´åå¥½',
      'æè§å»ºè®®è¾å¥æ¡'
    );
    await aiWaitFor('æè§è¾å¥å·²å®æ', { timeoutMs: 2000 });

    // ç½è´­ææå¿çæ¯ä»ä¹ï¼éæ©è¢«çå·è´¦æ·
    await aiScroll({ direction: 'down', distance: 200 }, 'é®å·é¡µé¢');
    await aiTap('"ç½è´­ææå¿çæ¯ä»ä¹"é®é¢ä¸­ç"è¢«çå·è´¦æ·"éé¡¹');
    await aiWaitFor('æåé®é¢éæ©å·²å®æ', { timeoutMs: 2000 });

    // æäº¤é®å·
    await aiScroll({ direction: 'down', scrollType: 'untilBottom' }, 'é®å·é¡µé¢');
    await aiTap('é¡µé¢åºé¨çæäº¤æé®');
    
    // ç­å¾æäº¤å®æå¹¶éªè¯ç»æ
    await aiWaitFor('æäº¤æåææè°¢åä¸é¡µé¢å·²æ¾ç¤º', { timeoutMs: 10000 });
    await aiAssert('é¡µé¢æ¾ç¤ºæäº¤æåææè°¢åä¸ä¿¡æ¯');

    // ä½¿ç¨aiAskè·åæäº¤éªè¯ä¿¡æ¯
    const submitResult = await aiAsk('å½åé¡µé¢æ¯å¦æ¾ç¤ºé®å·æäº¤æåçç¡®è®¤ä¿¡æ¯ï¼');
    console.log('é®å·æäº¤ç»æéªè¯:', submitResult);
    
    // éªè¯é®å·ç¡®å®å·²æäº¤
    expect(submitResult.toLowerCase()).toContain('æå');
  });
});
